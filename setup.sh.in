#!/bin/sh

print_help (){
    cat << HELPMSG
setup [--admin|--metro|--sup [--help|-h]]

Purpose: setup configure vigilo server.

Usage:  setup [--admin|--metro|--sup [--help|-h]]
Par défaut installe un serveur avec toutes les options.

--admin installe un serveur "Administration Centrale"
--metro installe un serveur "Stockage de données de métrlogie"
--sup   installe un serveur "Collecte de Supervision"

HELPMSG
    exit 0
}
while [ ! -z "$1" ]; do
    case "$1" in
        --help|-h)
            print_help
            ;;
        --admin)
            DO_admin="YES"
            shift
        ;;
        --metro)
            DO_metro="YES"
            shift
        ;;
        --sup)
            DO_sup="YES"
            shift
        ;;
        *)
            print_help
        ;;
    esac
done

TAG="all"
# if one variable is positionned don't do all
[ -z "$DO_admin" ] || TAG="admin"
[ -z "$DO_metro" ] || TAG="$TAG,metro"
[ -z "$DO_sup"   ] || TAG="$TAG,sup"

# if all variable is positionned do all
[ ! -z "$DO_admin" ] && [ ! -z "$DO_metro" ] && [ ! -z "$DO_sup" ] && TAG="all"


# remove caracter "," if first of all
if [ "${TAG:0:1}" == "," ];then
    TAG=${TAG:1}
fi
CONF=${CONF:-@SYSCONFDIR@/vigilo/setup/setup.conf}

if [ -f $CONF ]; then
    . $CONF
else
    echo "Can't find $CONF. Abort"
    exit 1
fi

# Tous les scripts doivent être idempotent.
# Ils seront lancés depuis leur répertoire.
vigilo_call_script() {
    script=$1
    dir=`dirname $script`
    tag=`cat $dir/TAG 2> /dev/null | sort -u | sed -e 's/ //g' -e '/^$/d' -e '/^#/d'`
    # check if this module is needed
    if [ "$TAG" != "all" ] ; then
        TAG_found="NO"
        for i in "$tag" ; do
            [ -z "$i" ] && return 0
            echo "$TAG" | grep -E -q "$i" && TAG_found="YES"
        done
        if [ "$TAG_found" != "YES" ]; then
            return 0
        fi
    fi
    pushd `dirname $script` > /dev/null
    bash ./`basename $script`
    RETVAL=$?
    if [ $RETVAL != 0 ]; then
        echo "Script $script failed !"
        exit $RETVAL
    fi
    popd > /dev/null
}

# D'abord, les scripts qui n'utilisent pas les données installées localement
for script in `ls $SETUP_MODULES/{0,1,2}*/run.sh 2>/dev/null`; do
    vigilo_call_script $script
done

echo
echo "La suite de ce script va créer les utilisateurs et les bases. C'est le moment de changer les mots de passe par défaut. Pour cela, arrêtez ce script (Ctrl-C), changez les mots de passe dans /etc/vigilo/*/settings.ini et relancez ce script. Appuyez sur Entrée pour continuer avec les mots de passe par défaut." | fmt
read

# Ensuite, les scripts qui utilisent les données de configuration locales
# (notamment les mots de passe)
for script in `ls $SETUP_MODULES/{3,4,5,6,7,8,9}*/run.sh 2>/dev/null`; do
    vigilo_call_script $script
done

if [ "$TAG" == "all" ]; then
    echo
    echo "Maintenant, vérifiez dans /var/log/messages que tout s'est bien passé. Nagios devrait tourner."
    echo "VigiBoard est accessible sur http://`hostname -f`/vigilo/vigiboard/"
    echo "VigiMap est accessible sur http://`hostname -f`/vigilo/vigimap/"
    echo "VigiGraph est accessible sur http://`hostname -f`/vigilo/vigigraph/"
    echo "Nagios est accessible sur http://`hostname -f`/nagios/ avec le login \"nagios\" et le mot de passe \""`cat /etc/nagios/passwd.plaintext`"\""
fi

echo "$TAG" | grep -E -q "sup"
if [ "$?" == "0" ]; then
    echo
    echo "Maintenant, vérifiez dans /var/log/messages que tout s'est bien passé. Nagios devrait tourner."
    echo "Nagios est accessible sur http://`hostname -f`/nagios/ avec le login \"nagios\" et le mot de passe \"`cat /etc/nagios/passwd.plaintext`\" "
fi

echo "$TAG" | grep -E -q "admin"
if [ "$?" == "0" ]; then
    echo
    echo "Maintenant, vérifiez dans /var/log/messages que tout s'est bien passé."
    echo "VigiBoard est accessible sur http://`hostname -f`/vigilo/vigiboard/"
    echo "VigiMap est accessible sur http://`hostname -f`/vigilo/vigimap/"
    echo "VigiGraph est accessible sur http://`hostname -f`/vigilo/vigigraph/"
fi

echo "$TAG" | grep -E -q "metro"
if [ "$?" == "0" ]; then
    echo
    echo "Maintenant, vérifiez dans /var/log/messages que tout s'est bien passé."
    echo "VigiRRD est accessible sur http://`hostname -f`/vigilo/vigirrd/"
fi

#TODO remplacer automatiquement les noms des serveurs dans les fichiers de configuration
#echo "Veuillez entrer l'adresse du serveur d'administation Centrale"
#echo "Veuillez entrer l'adresse du serveur de stockage des données de métrologie"
#echo "Veuillez entrer l'adresse du serveur de supervision"
